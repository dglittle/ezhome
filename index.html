<html>
<head>
<meta charset='utf-8'>
<title>untitled</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
<style>

</style>
<script>

var tau = 2*Math.PI

function drawBlueprint(o) {
    var d = $('<div style="width:100%;height:100%;">')
    function draw() {
        if (!img.complete || img.naturalWidth === 0) return
        var w = d.width()
        var h = d.height()
        if (w == 0 || h == 0) return
        var c = $('<canvas width="' + w + '" height="' + h + '"/>')
        var g = c[0].getContext('2d')

        var scale = (w/h > img.width/img.height) ? h/img.height : w/img.width

        var gridSize = scale * 1.0/o['scale (in per px)'] * 12 * 5
        for (var i = 1; i < h/gridSize; i++) {
            g.beginPath()
            g.moveTo(0, Math.round(gridSize * i) + 0.5)
            g.lineTo(w, Math.round(gridSize * i) + 0.5)
            g.lineWidth = '1px'
            g.strokeStyle = 'lightgrey'
            g.stroke()
        }
        for (var i = 1; i < w/gridSize; i++) {
            g.beginPath()
            g.moveTo(Math.round(gridSize * i) + 0.5, 0)
            g.lineTo(Math.round(gridSize * i) + 0.5, h)
            g.lineWidth = '1px'
            g.strokeStyle = 'lightgrey'
            g.stroke()
        }

        function drawRuler(x, y) {
            g.fillStyle = 'black'
            g.fillRect(Math.round(x), Math.round(y), Math.round(gridSize + 1), Math.round(gridSize/2))
            g.fillRect(Math.round(x + 2*gridSize), Math.round(y), Math.round(gridSize + 1), Math.round(gridSize/2))
            g.fillRect(Math.round(x + 4*gridSize), Math.round(Math.round(y)), Math.round(gridSize), Math.round(gridSize/2))

            g.beginPath()
            g.strokeStyle = 'black'
            g.rect(Math.round(x) + 0.5, Math.round(y) + 0.5, Math.round(5*gridSize), Math.round(gridSize/2))
            g.stroke()

            g.font = Math.round(gridSize/2) + "px Arial";
            g.textAlign = 'center'
            g.fillText('0 FT', x, y - gridSize*.1)
            g.fillText('25 FT', x + 5*gridSize, y - gridSize*.1)
        }
        drawRuler(gridSize, gridSize * (Math.floor((h - (gridSize/4)) / gridSize) - 1))

        function drawCompass(x, y, north) {
            g.beginPath()
            g.arc(x, y, gridSize, 0, tau)
            g.moveTo(x - gridSize*Math.cos(north), y + gridSize*Math.sin(north))
            g.lineTo(x + gridSize*Math.cos(north), y - gridSize*Math.sin(north))
            g.stroke()

            g.beginPath()
            g.moveTo(x, y)
            g.lineTo(x + gridSize*Math.cos(north), y - gridSize*Math.sin(north))
            g.lineWidth = gridSize/4
            g.stroke()

            g.font = 'bold ' + Math.round(gridSize/2) + "px Arial";
            g.translate(x + gridSize*Math.cos(north), y - gridSize*Math.sin(north))
            g.rotate(tau/4 - north)
            g.translate(0, -.1*gridSize)
            g.textAlign = 'center'
            g.fillText('N', 0, 0)
            g.setTransform(1, 0, 0, 1, 0, 0)
        }
        drawCompass(w - gridSize*2, gridSize*2, o.north)

        if (w/h > img.width/img.height) {
            var x = h/(img.height/img.width)
            g.drawImage(img, w/2 - x/2, 0, x, h)
        } else {
            var x = w/(img.width/img.height)
            g.drawImage(img, 0, h/2 - x/2, w, x)
        }
        d.empty().append(c)
    }
    var img = new Image
    img.onload = draw
    img.src = o.img
    setTimeout(draw, 0)
    return d
}

function drawForm(o) {
    var d = $('<div style="width:100%;height:100%"/>')

    function createCell(x, y) {
        return '<table style="width:100%"><tr><td>' + _.escapeXml(x) + '</td><td style="text-align: right">' + _.escapeXml(y) + '</td></tr></table>'
    }
    function createRow(x1, y1, x2, y2) {
        return '<tr><td colspan="2" style="border: 1px solid black;">' + createCell(x1, y1) + '</td><td colspan="2" style="border: 1px solid black;">' + createCell(x2, y2) + '</td></tr>'
    }

    var xs = _.pairs({
        'LOT AREA' : 'XXX',
        'SOFT AREA' : Math.round(o['soft (in^2)']/144) + ' SF',
        'LOT AREA FROM ZILLOW' : 'XXX',
        'F-LAWN AREA' : Math.round(o['flawn (in^2)']/144) + ' SF',
        'BUILDING AREA' : Math.round(o['building (in^2)']/144) + ' SF',
        'F-LAWN PERIMETER' : Math.round(o['flawn (in)']/12) + ' F',
        'POOL AREA' : Math.round(o['pool (in^2)']/144) + ' SF',
        'B-LAWN AREA' : Math.round(o['blawn (in^2)']/144) + ' SF',
        'HARD AREA' : Math.round(o['hard (in^2)']/144) + ' SF',
        'B-LAWN PERIMETER' : Math.round(o['blawn (in)']/12) + ' F'
    })

    var t = '<table style="width:100%;height:100%">'
    t += '<tr><td height="100%" align="center" colspan="4" style="border: 1px solid black;" class="sketchup"></td></tr>'
    for (var i = 0; i < xs.length; i += 2) {
        t += createRow(xs[i][0], xs[i][1], xs[i + 1][0], xs[i + 1][1])
    }
    t += '<tr><td colspan="1" style="border: 1px solid black;">Client Name:</td><td colspan="2" rowspan="4" style="border: 1px solid black;">555 Somewhere, Somecity, CA 95555</td><td colspan="1" rowspan="1" style="border: 1px solid black;">Drawn by</td></tr>'
    t += '<tr><td colspan="1" style="border: 1px solid black;">Phone:</td><td colspan="1" rowspan="3" style="border: 1px solid black;"><img style="width:200px" src="ezhome.png" /></td></tr>'
    t += '<tr><td colspan="1" style="border: 1px solid black;">E-mail:</td></tr>'
    t += '<tr><td colspan="1" style="border: 1px solid black;">Date:</td></tr>'
    t += '</table>'
    t = $(t)

    t.find('.sketchup').append(drawBlueprint(o))

    d.append(t)
    return d
}

$(function () {
    $('head').append($('<style> html { box-sizing: border-box; } *, *:before, *:after { box-sizing: inherit; } body { margin: 0px } table { border-collapse: collapse; } th, td { padding: 0px; } </style>'))
    
    $(document).ajaxError(function () {
        console.log('oh no, AJAX badness happened!')
    })

    var params = _.getUrlParams()
    if (params.sketchup) {
        var header = $('<div/>')
        header.append($('<input type="text"/>'))
        header.append($('<button/>').text('update').click(function () {
            var homeKey = header.find('input').val()
            frame.attr('src', window.location.href.match(/(.*?)\?/)[1] + '?homeKey=' + _.escapeUrl(homeKey))
            window.location.href = 'skp:ezhome_upload@' + homeKey
        }))
        header.append($('<button/>').text('send model to sketchup').click(function () {
            if (confirm('this will overwrite your model in sketchup, is this ok?')) {
                var homeKey = header.find('input').val()
                window.location.href = 'skp:ezhome_download@' + homeKey
            }
        }))
        header.append($('<button/>').text('save image').click(function () {
            alert('not implemented yet..')
        }))



        // work here
        header.append($('<div/>').text('begin6'))
        var w = 100
        var h = 100
        var c = $('<canvas width="' + w + '" height="' + h + '"/>')
        try {
            var g = c[0].getContext('2d')
        } catch (e) {
            header.append($('<div/>').text('err: ' + e))
            header.append($('<div/>').text('err: ' + e.message))
        }

        // g.beginPath()
        // g.moveTo(0, 0)
        // g.lineTo(100, 100)
        // g.lineWidth = '1px'
        // g.strokeStyle = 'lightgrey'
        // g.stroke()
        // header.append(c)
        header.append($('<div/>').text('end'))




        var frame = $('<iframe frameborder="0" width="100%" height="100%">')
        $('body').append(_.splitVert(2, 1, header, frame))
    } else if (params.homeKey) {
        var d = $('<div style="width:100%;height:100%"/>')
        $('body').append(d)

        var fb = new Firebase('https://ezhome.firebaseio.com/home/' + _.escapeUrl(params.homeKey))
        var f = fb.on('value', function (o) {
            d.empty().append(drawForm(o.val()))
        })
    }
})

</script>
</body>
</html>
